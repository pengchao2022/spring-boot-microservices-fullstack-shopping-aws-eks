server:
  port: 8083
  servlet:
    context-path: /api
  compression:
    enabled: true
    mime-types: text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json
    min-response-size: 1024
  tomcat:
    max-connections: 10000
    max-threads: 200
    min-spare-threads: 10
    connection-timeout: 30000
    keep-alive-timeout: 30000

spring:
  application:
    name: payment-service
  profiles:
    active: ${SPRING_PROFILES_ACTIVE:production}
  datasource:
    url: ${SPRING_DATASOURCE_URL:jdbc:postgresql://localhost:5432/ecommerce_payments}
    username: ${SPRING_DATASOURCE_USERNAME:${DB_USERNAME:postgres}}
    password: ${SPRING_DATASOURCE_PASSWORD:${DB_PASSWORD:password}}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 10
      minimum-idle: 2
      connection-timeout: 30000
      idle-timeout: 300000
      max-lifetime: 1200000
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: true
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        jdbc:
          batch_size: 20
        order_inserts: true
        order_updates: true
  rabbitmq:
    host: ${SPRING_RABBITMQ_HOST:localhost}
    port: ${SPRING_RABBITMQ_PORT:5672}
    username: ${SPRING_RABBITMQ_USERNAME:guest}
    password: ${SPRING_RABBITMQ_PASSWORD:guest}
    virtual-host: ${SPRING_RABBITMQ_VIRTUAL_HOST:/}
    connection-timeout: 10000
    template:
      retry:
        enabled: true
        initial-interval: 5000
        multiplier: 2
        max-attempts: 3
    listener:
      simple:
        missing-queues-fatal: false
        auto-startup: false
  flyway:
    enabled: ${SPRING_FLYWAY_ENABLED:true}
    locations: classpath:db/migration
    baseline-on-migrate: ${SPRING_FLYWAY_BASELINE_ON_MIGRATE:true}
    validate-on-migrate: ${SPRING_FLYWAY_VALIDATE_ON_MIGRATE:true}
    table: flyway_schema_history_payment

# 支付宝配置
alipay:
  app-id: ${ALIPAY_APP_ID:2021006103655907}
  private-key: ${ALIPAY_PRIVATE_KEY}
  public-key: ${ALIPAY_PUBLIC_KEY}
  gateway: ${ALIPAY_GATEWAY_URL:https://openapi.alipay.com/gateway.do}
  notify-url: ${ALIPAY_NOTIFY_URL:https://awsmpc.asia/api/payments/webhook/alipay}
  return-url: ${ALIPAY_RETURN_URL:https://awsmpc.asia/payment/success}
  sign-type: ${ALIPAY_SIGN_TYPE:RSA2}
  charset: ${ALIPAY_CHARSET:UTF-8}
  format: ${ALIPAY_FORMAT:JSON}
  version: ${ALIPAY_VERSION:1.0}
  product-code: ${ALIPAY_PRODUCT_CODE:FAST_INSTANT_TRADE_PAY}
  timeout-express: ${ALIPAY_TIMEOUT_EXPRESS:15m}
  environment: ${ALIPAY_ENVIRONMENT:PRODUCTION}
  enable-log: ${ALIPAY_ENABLE_LOG:true}
  log-path: ${ALIPAY_LOG_PATH:/var/log/alipay}

# 支付服务配置
payment:
  timeout-minutes: ${PAYMENT_TIMEOUT_MINUTES:15}
  max-payment-amount: ${MAX_PAYMENT_AMOUNT:10000.00}
  default-currency: ${DEFAULT_CURRENCY:CNY}
  allow-partial-refunds: ${ALLOW_PARTIAL_REFUNDS:true}
  max-retry-count: 3
  allowed-origins: http://localhost:3000,http://localhost:8080,https://awsmpc.asia
  supported-currencies: ${SUPPORTED_CURRENCIES:CNY}

# 微服务通信配置
service:
  order:
    url: ${ORDER_SERVICE_URL:http://order-service:8080}
  notification:
    url: ${NOTIFICATION_SERVICE_URL:http://notification-service:8080}

# 日志配置
logging:
  level:
    com.ecommerce.payment: ${LOG_LEVEL:DEBUG}
    com.alipay: ${ALIPAY_LOG_LEVEL:INFO}
    org.hibernate.SQL: ${HIBERNATE_SQL_LOG:DEBUG}
    org.hibernate.type.descriptor.sql.BasicBinder: TRACE
    org.springframework.web: INFO
    org.springframework.amqp: ${RABBITMQ_LOG_LEVEL:INFO}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: logs/payment-service.log
    max-size: 10MB
    max-history: 30

# Actuator 配置 - 简化版本，使用主服务器
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,env,beans,configprops
      base-path: /actuator
    enabled-by-default: true
  endpoint:
    health:
      show-details: always
      show-components: always
      probes:
        enabled: true
    info:
      enabled: true
    metrics:
      enabled: true
  info:
    env:
      enabled: true
    build:
      enabled: true
    git:
      enabled: true
  health:
    db:
      enabled: true
    diskspace:
      enabled: true
    rabbit:
      enabled: true
    livenessstate:
      enabled: true
    readinessstate:
      enabled: true
  # 移除独立的 management 服务器配置
  # server:
  #   port: 8084
  #   base-path: /management

# 安全配置
security:
  basic:
    enabled: false

# Resilience4j 断路器配置
resilience4j:
  circuitbreaker:
    instances:
      paymentService:
        register-health-indicator: true
        sliding-window-size: 10
        minimum-number-of-calls: 5
        permitted-number-of-calls-in-half-open-state: 3
        wait-duration-in-open-state: 10s
        failure-rate-threshold: 50
        event-consumer-buffer-size: 10
  retry:
    instances:
      paymentService:
        max-attempts: 3
        wait-duration: 2s
  timelimiter:
    instances:
      paymentService:
        timeout-duration: 30s

# 消息配置
spring-cloud:
  stream:
    bindings:
      paymentOutput:
        destination: payment-events
        group: payment-service
      orderInput:
        destination: order-events
        group: payment-service
    rabbit:
      bindings:
        paymentOutput:
          producer:
            routing-key-expression: '''payment.event'''
        orderInput:
          consumer:
            binding-routing-key: order.event.*
            queue-name-group-only: true

# Webhook 配置
webhook:
  alipay-endpoint: ${ALIPAY_WEBHOOK_ENDPOINT:/api/payments/webhook/alipay}
  success-url: ${WEBHOOK_SUCCESS_URL:https://awsmpc.asia/payment/success}
  cancel-url: ${WEBHOOK_CANCEL_URL:https://awsmpc.asia/payment/cancel}

# 加密配置
encryption:
  key: ${ENCRYPTION_KEY}